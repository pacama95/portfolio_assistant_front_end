openapi: 3.0.3
info:
  title: Portfolio Insights Agent API
  version: "1.0.0"
  description: |
    HTTP API that streams the progress of generating daily portfolio insights (via Server-Sent Events)
    and returns a final JSON object that follows a strict contract.
servers:
  - url: https://your-railway-app.up.railway.app
    description: Railway
  - url: http://localhost:8080
    description: Local development
paths:
  /health:
    get:
      summary: Health check
      operationId: getHealth
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
  /insights:
    post:
      summary: Generate portfolio insights (final JSON)
      operationId: postInsights
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InsightsRequest"
            examples:
              example:
                value:
                  query: "Generate today's portfolio insights"
                  thread_id: "optional-thread"
      responses:
        "200":
          description: Final insights JSON
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InsightsResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /insights/stream:
    get:
      summary: Stream progress events (SSE) while generating insights
      operationId: getInsightsStream
      parameters:
        - in: query
          name: query
          required: true
          schema:
            type: string
            minLength: 2
          description: User request for insights
        - in: query
          name: thread_id
          required: false
          schema:
            type: string
          description: Optional thread identifier
      responses:
        "200":
          description: Server-Sent Events stream
          content:
            text/event-stream:
              schema:
                type: string
                description: SSE formatted stream
              examples:
                example:
                  summary: Event stream example
                  value: |
                    event: planner:start
                    data: {"thread_id":"default"}

                    event: planner:done
                    data: {"status":"planned"}

                    event: assistant:invoke
                    data: {"retry":0}

                    event: progress
                    data: {"action":"retrieving_portfolio_summary","subject":"active"}

                    event: validator:ok
                    data: {"size":1234}

                    event: judge:done
                    data: {"status":"CORRECT"}

                    event: final
                    data: {"version":"1.0","generated_at_utc":"2025-10-06T18:25:00Z","insights":[]}
    post:
      summary: Stream progress events (SSE) while generating insights (POST body)
      operationId: postInsightsStream
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InsightsRequest"
            examples:
              example:
                value:
                  query: "Generate today's portfolio insights"
                  thread_id: "optional-thread"
      responses:
        "200":
          description: Server-Sent Events stream
          content:
            text/event-stream:
              schema:
                type: string
              examples:
                example:
                  value: |
                    event: progress
                    data: {"action":"searching_latest_news","subject":"AAPL earnings guidance"}

                    event: final
                    data: {"version":"1.0","generated_at_utc":"2025-10-06T18:25:00Z","insights":[]}
components:
  schemas:
    HealthResponse:
      type: object
      properties:
        ok:
          type: boolean
          example: true
        service:
          type: string
          example: portfolio-insights-agent
      required: [ok, service]
    InsightsRequest:
      type: object
      properties:
        query:
          type: string
          minLength: 2
          description: User request for insights
        thread_id:
          type: string
          nullable: true
          description: Optional thread identifier
      required: [query]
    Error:
      type: object
      properties:
        error:
          type: string
          example: "'query' must be a non-empty string"
    InsightKeyNumber:
      type: object
      properties:
        label:
          type: string
          example: "Portfolio return (day)"
        value:
          type: number
          example: 3.1
        unit:
          type: string
          example: "%"
      required: [label, value, unit]
    Insight:
      type: object
      properties:
        type:
          type: string
          enum: [performance, alert, risk, opportunity]
        title:
          type: string
          description: 2–5 words
          example: "Outperforms S&P"
        summary:
          type: string
          description: One sentence (18–28 words) with specific numbers
        details:
          type: string
          description: One sentence (25–45 words) adding context/comparisons/action to consider (not advice)
        tickers:
          type: array
          items:
            type: string
          description: Empty if portfolio-level
        key_numbers:
          type: array
          minItems: 1
          maxItems: 5
          items:
            $ref: "#/components/schemas/InsightKeyNumber"
        sources:
          type: array
          items:
            type: string
          description: Include at least one URL when external info is used; else []
        priority:
          type: integer
          minimum: 1
          maximum: 5
      required: [type, title, summary, details, tickers, key_numbers, sources, priority]
    InsightsResponse:
      type: object
      properties:
        version:
          type: string
          example: "1.0"
        generated_at_utc:
          type: string
          format: date-time
          example: "2025-10-06T18:25:00Z"
        insights:
          type: array
          minItems: 0
          maxItems: 6
          items:
            $ref: "#/components/schemas/Insight"
      required: [version, generated_at_utc, insights]
    # Optional: Document individual SSE event payloads (non-normative for OpenAPI)
    SseEventPlannerStart:
      type: object
      properties:
        event:
          type: string
          enum: [planner:start]
        data:
          type: object
          properties:
            thread_id:
              type: string
    SseEventPlannerDone:
      type: object
      properties:
        event:
          type: string
          enum: [planner:done]
        data:
          type: object
          properties:
            status:
              type: string
              example: planned
    SseEventAssistantInvoke:
      type: object
      properties:
        event:
          type: string
          enum: [assistant:invoke]
        data:
          type: object
          properties:
            retry:
              type: integer
              minimum: 0
    SseEventProgress:
      type: object
      properties:
        event:
          type: string
          enum: [progress]
        data:
          type: object
          properties:
            action:
              type: string
              enum:
                - searching_latest_news
                - checking_reference_information
                - retrieving_portfolio_summary
                - retrieving_positions
                - retrieving_position_details
                - retrieving_transactions
                - updating_transactions
                - updating_market_data
                - processing
            subject:
              type: string
              description: Optional context string (e.g., ticker or query)
    SseEventValidatorFail:
      type: object
      properties:
        event:
          type: string
          enum: [validator:fail]
        data:
          type: object
          properties:
            status:
              type: string
              example: invalid
            issues:
              type: integer
              minimum: 1
    SseEventValidatorOk:
      type: object
      properties:
        event:
          type: string
          enum: [validator:ok]
        data:
          type: object
          properties:
            size:
              type: integer
              minimum: 0
    SseEventJudgeDone:
      type: object
      properties:
        event:
          type: string
          enum: [judge:done]
        data:
          type: object
          properties:
            status:
              type: string
              enum: [CORRECT, INCORRECT, ERROR]
    SseEventFinal:
      type: object
      properties:
        event:
          type: string
          enum: [final]
        data:
          $ref: "#/components/schemas/InsightsResponse"
    SseEventError:
      type: object
      properties:
        event:
          type: string
          enum: [error]
        data:
          type: object
          properties:
            message:
              type: string
    SseEvent:
      oneOf:
        - $ref: "#/components/schemas/SseEventPlannerStart"
        - $ref: "#/components/schemas/SseEventPlannerDone"
        - $ref: "#/components/schemas/SseEventAssistantInvoke"
        - $ref: "#/components/schemas/SseEventProgress"
        - $ref: "#/components/schemas/SseEventValidatorFail"
        - $ref: "#/components/schemas/SseEventValidatorOk"
        - $ref: "#/components/schemas/SseEventJudgeDone"
        - $ref: "#/components/schemas/SseEventFinal"
        - $ref: "#/components/schemas/SseEventError"
